# Google Calendar連携 トラブルシューティングガイド

## 問題: 予定を登録してもGoogle Calendarに反映されない

このドキュメントは、予定を登録しても役員のGoogle Calendarに反映されない問題を診断・解決するための手順書です。

---

## ⚠️ 重要: スコープ変更後の再認証

**2025-11-10のアップデート後、初めて使用する場合**は、以下の手順で再認証が必要です：

### 再認証の手順

1. **ブラウザの開発者ツールを開く**
   - キーボードで `F12` を押す

2. **Consoleタブで以下を実行**
   ```javascript
   localStorage.removeItem('exec-schedule:auth');
   ```

3. **ページをリロード**
   - `Ctrl + R` または `F5` キーを押す

4. **「Google連携」ボタンをクリック**
   - 画面上部の「Google連携」ボタンをクリック
   - Googleアカウントを選択
   - **新しい権限リクエスト**が表示されます：
     - ✅ Google カレンダーの予定の表示と編集
     - ✅ **カレンダーの空き情報の表示**（新規追加）
   - 「許可」をクリック

5. **ボタンが「Google連携済み」に変わることを確認**

これで、カレンダーID検証機能が正常に動作するようになります。

---

## 📋 診断手順

### ステップ1: ブラウザのConsoleログを確認

1. **開発者ツールを開く**
   - キーボードで `F12` を押す
   - または、右クリック → 「検証」をクリック

2. **Consoleタブを選択**

3. **起動時のデバッグ情報を確認**

   以下のような情報が表示されます：
   ```
   === 役員スケジュール管理システム デバッグ情報 ===
   Google認証状態: ✅ 認証済み  または  ❌ 未認証

   役員情報:
   ┌─────────┬──────────┬────────────────────────┬──────────────────┐
   │ 役職    │ メール   │ カレンダーID           │ ID設定状況       │
   ├─────────┼──────────┼────────────────────────┼──────────────────┤
   │ 局長    │ xxx@...  │ xxx@example.com        │ ✅               │
   │ 事務次長│ (未設定) │ (未設定)               │ ❌               │
   └─────────┴──────────┴────────────────────────┴──────────────────┘
   ```

4. **予定を作成してみる**

   以下のいずれかのメッセージが表示されます：

#### パターンA: 認証されていない場合

```
[Google Sync] 同期開始: {executiveId: "exec-1", title: "会議"}
[Google Sync] 認証されていません。「Google連携」ボタンをクリックして認証してください。
```

**→ 解決策: ステップ2に進む**

---

#### パターンB: カレンダーIDが未設定の場合

```
[Google Sync] 同期開始: {executiveId: "exec-1", title: "会議"}
[Google Sync] 認証OK
[Google Sync] 役員情報: {id: "exec-1", title: "局長", calendarId: "(未設定)"}
[Google Sync] カレンダーIDが設定されていません。設定画面で設定してください。
```

**→ 解決策: ステップ3に進む**

---

#### パターンC: カレンダーIDが無効な場合

```
[Google Sync] 同期開始: {executiveId: "exec-1", title: "会議"}
[Google Sync] 認証OK
[Google Sync] 役員情報: {id: "exec-1", title: "局長", calendarId: "invalid@example.com"}
[Google Sync] カレンダーIDあり、同期を実行します...
[Google Sync] 新規イベントを作成: invalid@example.com
[Google Sync] 同期エラー: {status: 404, message: "Not Found"}
```

**→ 解決策: ステップ3に進む**

---

#### パターンD: 権限エラー

```
[Google Sync] 同期エラー: {status: 403, message: "Forbidden"}
```

**→ 解決策: ステップ4に進む**

---

## 🔧 解決手順

### ステップ2: Google認証を完了する

**問題**: Google認証が完了していない

**解決方法**:

1. 画面上部の **「Google連携」ボタン** をクリック
2. Googleアカウントの選択画面が表示される
3. 役員のGoogleアカウントを選択
4. 「Google Calendar APIへのアクセスを許可」で **「許可」** をクリック
5. ボタンのテキストが **「Google連携済み」** に変わることを確認
6. 再度予定を作成してみる

**確認方法**:
- Consoleに `Google認証状態: ✅ 認証済み` と表示される
- 予定作成時に `[Google Sync] 認証OK` と表示される

---

### ステップ3: カレンダーIDを正しく設定する

**問題**: カレンダーIDが未設定、または無効

**解決方法**:

1. **正しいカレンダーIDを取得**

   - **個人カレンダーの場合**: 通常はGoogleアカウントのメールアドレスと同じ
     - 例: `yamada.taro@wakayama-med.ac.jp`

   - **共有カレンダーの場合**:
     1. Google Calendarを開く
     2. 左側のカレンダー一覧から該当カレンダーの「︙」をクリック
     3. 「設定と共有」をクリック
     4. 「カレンダーの統合」セクションにある **「カレンダーID」** をコピー
        - 例: `c_abc123def456@group.calendar.google.com`

2. **設定画面でカレンダーIDを入力**

   1. 画面右上の **「⚙ 設定」ボタン** をクリック
   2. 該当する役員の「カレンダーID」欄に正しいIDを入力
   3. **「保存」ボタン** をクリック

3. **検証結果を確認**

   - **認証済みの場合**: カレンダーIDが有効か自動検証される
   - **無効なIDの場合**: 警告メッセージが表示される
     ```
     以下のカレンダーIDが無効です:

     局長: カレンダーID「xxx@example.com」は無効です

     このまま保存しますか？
     ```
   - **キャンセル** して正しいIDを再入力する

4. **再度予定を作成してみる**

**確認方法**:
- Consoleのデバッグ情報で `ID設定状況: ✅` と表示される
- 予定作成時に `[Google Sync] カレンダーIDあり、同期を実行します...` と表示される
- `[Google Sync] 作成成功！Google Event ID: xxx` と表示される

---

### ステップ4: アクセス権限を確認する

**問題**: 共有カレンダーへのアクセス権限がない

**解決方法**:

1. **共有カレンダーの権限を確認**

   - カレンダーの所有者に連絡して、以下を確認:
     - 認証したGoogleアカウントがカレンダーに追加されているか
     - 権限が **「予定の変更」** 以上に設定されているか

2. **権限の付与方法（カレンダー所有者向け）**

   1. Google Calendarを開く
   2. 該当カレンダーの「︙」→「設定と共有」をクリック
   3. 「特定のユーザーと共有」セクションで **「ユーザーを追加」**
   4. 認証に使用するGoogleアカウントのメールアドレスを入力
   5. 権限を **「予定の変更」** に設定
   6. **「送信」** をクリック

3. **再度予定を作成してみる**

---

### ステップ5: 認証トークンの期限切れ

**問題**: 認証トークンが期限切れ

**症状**:
```
[Google Sync] 認証トークンが期限切れです
```

**解決方法**:

1. 画面上部の **「Google連携」ボタン** を再度クリック
2. 認証を再度実行
3. 予定を再作成

**確認方法**:
- アラートメッセージが表示されない
- 予定がGoogle Calendarに反映される

---

## 📊 よくある質問（FAQ）

### Q1: 「Google連携済み」になっているのに同期されない

**A**: 以下を確認してください：

1. カレンダーIDが正しく設定されているか（ステップ3）
2. Consoleログで実際のエラーを確認（ステップ1）
3. 共有カレンダーの場合、アクセス権限があるか（ステップ4）

---

### Q2: カレンダーIDは「通常はメールアドレスと同じ」とあるが、違う場合は？

**A**: 以下のケースがあります：

- **個人カレンダー**: 通常はメールアドレスと同じ
- **共有カレンダー**: `c_xxx@group.calendar.google.com` のような形式
- **特殊なカレンダー**: Google Calendarの設定から確認が必要

正確なカレンダーIDは、必ずGoogle Calendarの「設定と共有」→「カレンダーの統合」から取得してください。

---

### Q3: 複数の役員のカレンダーを管理したい

**A**: 以下の2つの方法があります：

**方法1: 各役員のアカウントで個別に認証**
- 各役員が自分のGoogleアカウントで認証
- カレンダーIDは各自のメールアドレス

**方法2: 共有カレンダーで一括管理**
- 各役員用の共有カレンダーを作成
- 管理者アカウントで認証
- 管理者アカウントに各カレンダーの「予定の変更」権限を付与
- カレンダーIDは共有カレンダーのID

**推奨**: 方法2（共有カレンダー方式）が管理しやすい

---

### Q4: ローカルには保存されているが、Google Calendarには反映されない

**A**: これは正常な動作です。以下の理由が考えられます：

1. **認証されていない**: 予定作成時に「認証せずにローカルのみに保存」を選択した
2. **カレンダーID未設定**: 同期できないため、ローカルのみに保存された
3. **同期エラー**: API呼び出しに失敗したが、ローカルには保存された

**解決**: 認証とカレンダーID設定を完了後、該当の予定を編集して保存し直してください。

---

### Q5: 予定は反映されるが、更新や削除が反映されない

**A**: 以下を確認してください：

1. **Google Event IDが保存されているか**
   - LocalStorageを確認: `localStorage.getItem('exec-schedule:events')`
   - 各イベントに `googleEventId` フィールドがあるか確認

2. **権限が十分か**
   - 共有カレンダーの場合、「予定の変更」権限が必要

3. **Consoleログでエラーを確認**
   - 更新・削除時のエラーメッセージを確認

---

### Q6: カレンダーIDが正しいのに「検証に失敗しました」と表示される

**A**: 以下の理由が考えられます：

1. **共有カレンダーの権限が不足**
   - カレンダーIDは正しいが、「予定の表示」権限しかない
   - 解決策: カレンダー所有者に「予定の変更」権限を付与してもらう

2. **一時的なネットワークエラー**
   - Google Calendar APIへの接続が一時的に失敗した
   - 解決策: 数分待ってから再度試す

3. **検証をスキップして保存**
   - 検証に失敗しても「このまま保存しますか？」で「OK」を選択すれば保存可能
   - 実際の予定登録時に同期が成功すれば問題なし

**検証の仕組み（技術的詳細）**:
- 設定画面では、FreeBusy APIを使用してカレンダーへのアクセス権限をテストしています
- このAPIは、カレンダーに対して「予定の表示」または「予定の変更」権限があれば成功します
- 検証に失敗しても、実際の予定登録時に成功する場合があります（ネットワークエラーの場合など）

**推奨される対応**:
1. まず「このまま保存しますか？」で「OK」を選択して保存
2. 実際に予定を作成してみる
3. 予定がGoogle Calendarに反映されれば問題なし
4. 反映されない場合は、カレンダーの共有設定を確認

---

## 🛠 高度なトラブルシューティング

### LocalStorageの内容を確認

Consoleで以下を実行：

```javascript
// 役員データの確認
const executives = JSON.parse(localStorage.getItem('exec-schedule:executives'));
console.table(executives.map(e => ({
  title: e.title,
  email: e.email,
  calendarId: e.calendarId
})));

// 認証トークンの確認
const token = localStorage.getItem('exec-schedule:auth');
console.log('認証トークン:', token ? '存在する' : '存在しない');

// イベントデータの確認
const events = JSON.parse(localStorage.getItem('exec-schedule:events'));
console.log('登録イベント数:', events.length);
console.table(events.map(e => ({
  title: e.title,
  executiveId: e.executiveId,
  googleEventId: e.googleEventId || '(未同期)'
})));
```

---

### Google Calendar APIの設定を確認

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 使用しているプロジェクトを選択
3. 「APIとサービス」→「ダッシュボード」
4. Google Calendar APIが有効化されているか確認
5. 「認証情報」→OAuth 2.0クライアントIDの設定確認:
   - 承認済みのJavaScript生成元に開発サーバーのURLが含まれているか
   - 例: `http://localhost:5173`

---

## 📝 修正内容のまとめ（開発者向け）

今回の修正で以下が改善されました：

1. **エラーメッセージの改善**
   - `syncEventToGoogle()` が `SyncResult` 型を返すように変更
   - 早期リターン時もエラーメッセージがユーザーに表示される

2. **認証状態の事前チェック**
   - イベント作成前に認証状態を確認
   - 未認証の場合は確認ダイアログを表示

3. **カレンダーID検証機能**
   - 設定保存時にカレンダーIDの有効性を検証
   - 無効なIDは保存前に警告

4. **カレンダーID検証ロジックの改善（2025-11-10追加）**
   - `calendars.get` APIから `freebusy.query` APIに変更
   - 共有カレンダーや他人のカレンダーでも正しく検証できるように改善
   - エラーメッセージをより分かりやすく変更

5. **デバッグ情報の出力**
   - 起動時に認証状態とカレンダーID設定状況を自動出力
   - 問題の早期発見が可能

6. **APIスコープの追加（2025-11-10追加）**
   - `calendar.freebusy` スコープを追加
   - FreeBusy APIによるカレンダーID検証が正常に動作するように改善
   - **再認証が必要**（LocalStorageのトークンをクリア）

---

## 📞 サポート

それでも問題が解決しない場合は、以下の情報を添えて開発者に連絡してください：

1. **ブラウザのConsoleログ** (F12 → Consoleタブの内容をコピー)
2. **発生したエラーメッセージ**
3. **実行した操作の手順**
4. **認証状態とカレンダーID設定状況** (デバッグ情報のスクリーンショット)

---

**最終更新日**: 2025-11-10
